## Goal: Merge 'Description_PFC' and 'TC2' based on Product.Pack.Name variable.

## Read TC2
  TC2 <- read.csv("~/Dropbox/IMS data/Edited/TC2.csv")

## Create variable Product.Pack.Name_NOSPACE which is variable "Product.Pack.Name" without spaces in TC2
  TC2$Product.Pack.Name_NOSPACE <- str_replace_all(TC2$Product.Pack.Name, fixed(" "), "")

## Read Description_PFC
  Description_PFC <- read.csv("~/Dropbox/IMS data/Edited/PMD13/PMD codes/Description_PFC.csv", na.strings="")

## Rename variables in Description_PFC
  Description_PFC <- plyr::rename(Description_PFC, c("PRODDESC"="PFC.Product", 
                                                    "PACKDESC"="PFC.Pack",
                                                    "LABCODE"="PFC.Lab.Code",
                                                    "LABDESC"="PFC.Lab.Desc",
                                                    "ATCCODE"="ATC",
                                                    "NFCCODE"="NFC"
                                                       ))
  
## Paste together Product variable and Pack variable separated by a space
  Description_PFC$PFC.Product.Pack.Name <- paste(Description_PFC$PFC.Product, Description_PFC$PFC.Pack, sep = " ")
  
## Create Product.Pack.Name variables without spaces in Description_PFC
  Description_PFC$Product.Pack.Name_NOSPACE <- str_replace_all(Description_PFC$PFC.Product.Pack.Name, fixed(" "), "")
  
## Revalue some Product.Pack.Name_NOSPACE cells in TC2 to match Product.Pack.Name_NOSPACE in Description_PFC 
  
  TC2$Product.Pack.Name_NOSPACE<- plyr::revalue(TC2$Product.Pack.Name_NOSPACE, c(
    "ABSLAGUNDITEATEABAGS12X2G"="ABSLAGUNDITEATEABAGS2G12", 
    "AEKNILAMP150MG/ML100X2ML"="AEKNILAMP150MG/ML2ML100", 
    "AEKNILAMP150MG/ML10X2ML"="AEKNILAMP150MG/ML2ML10", 
    "AMADOLA.IV150MG/ML10X2ML"="AMADOLA.IV150MG/ML2ML10", 
    "AMARATAB2MG30BLIS"="AMARATAB2MG30", 
    "AMARYLLVLS50MG/ML10X2ML"="AMARYLLVLS50MG/ML2ML10", 
    "APIDRAPENPFSOLOS100IU/ML5X3ML"="APIDRAPENPFSOLOSTAR100IU/ML3ML5", 
    "ASCOFSYRSACM.SF600MGFORT60X5ML"="ASCOFSYRSACM.SF600MGFORT5ML60", 
    "ASCOFSYRSACMENT600MGFORT60X5ML"="ASCOFSYRSACMENT600MGFORT5ML60", 
    "ASCOFSYRSACPONK300MG/5ML60X10ML"="ASCOFSYRSACPONK300MG/5ML10ML60", 
    "ASCOFSYRSACSTRW300MG/5ML60X10ML"="ASCOFSYRSACSTRW300MG/5ML10ML60", 
    "ATRIVEXORALDRP7.5MG15ML"="ATRIVEXORALDRP7.5MG/ML15ML1", 
    "ATRIVEXSYR15MG60ML"="ATRIVEXSYR15MG/5ML60ML1", 
    "BIOGESICGRNFASTFIZZ500MG30X3.89G"="BIOGESICGRNFASTFIZZ500MG3.89G30", 
    "BRICANYLSYREXPT6X60ML"="BRICANYLSYREXPT60ML6", 
    "DAFENACAMP25MG/ML10X3ML"="DAFENACAMP25MG/ML3ML10", 
    "DECOLGENTABPE100FOIL"="DECOLGENTABPE100", 
    "DEMEROLAMP100MG/2ML25X2ML"="DEMEROLAMP100MG/2ML2ML25", 
    "DIFLOSIDA.IM25MG/ML10X3ML"="DIFLOSIDA.IM25MG/ML3ML10", 
    "DOLMALAMP50MG/ML50X2ML"="DOLMALAMP50MG/ML1ML50", 
    "ENDURPINAMP10MG/ML10X1ML"="ENDURPINAMP10MG/ML1ML10", 
    "FENOFLEXCAP160MG30BLIS"="FENOFLEXCAP160MG30", 
    "FLUIMUCILA.IM100MG/ML5X3ML"="FLUIMUCILA.IM100MG/ML3ML5", 
    "FLUIMUCILAMPINHA100MG/ML5X3ML"="FLUIMUCILAMPINHA100MG/ML3ML5", 
    "FLUMEXGRNSACHET200MG60X3G"="FLUMEXGRNSACHET200MG3G60", 
    "GALVUSTAB50MG28BLIS"="GALVUSTAB50MG28", 
    "GESITRAMAMP50MG/ML10X2ML"="GESITRAMAMP50MG/ML2ML10", 
    "GETWELLSIPTEABAGS2X5G"="GETWELLSIPTEABAGS5G2", 
    "HUMALOGCARTRIDGE100IU/ML5X3ML"="HUMALOGCARTRIDGE100IU/ML3ML5", 
    "HUMALOGKWIKPEN100U/ML5X3ML"="HUMALOGKWIKPEN100U/ML3ML5", 
    "HUMALOGMIX25CARTRIDGE100MG/ML5X3ML"="HUMALOGMIX25CARTRIDGE100IU/ML3ML5", 
    "HUMALOGMIX25KWIKPEN100U/ML5X3ML"="HUMALOGMIX25KWIKPEN100U/ML3ML5", 
    "HUMALOGMIX50KWIKPEN100U/ML5X3ML"="HUMALOGMIX50KWIKPEN100U/ML3ML5", 
    "HUMULIN70/30CARTRIDGE100IU/ML5X3ML"="HUMULIN70/30CARTRIDGE100IU/ML3ML5", 
    "HUMULINNCARTRIDGE100IU/ML5X3ML"="HUMULINNCARTRIDGE100IU/ML3ML5", 
    "INSULATARDHMFLEXPEN100IU/ML5X3ML"="INSULATARDHMFLEXPEN100IU/ML3ML5", 
    "KETANOVAMP30MG/ML10X1ML"="KETANOVAMP30MG/ML1ML10", 
    "KETEROA.IM30MG/ML5X1ML"="KETEROA.IM30MG/ML1ML5", 
    "KETESSEAMP25MG/ML5X2ML"="KETESSEAMP25MG/ML2ML5", 
    "KETLACVLS30MG/ML5X1ML"="KETLACVLS30MG/ML1ML5", 
    "KETOAMP30MG/ML10X1ML"="KETOAMP30MG/ML1ML10",
    "KETOBETAMP30MG/ML5X1ML"="KETOBETAMP30MG/ML1ML5",
    "KETODOLAMP30MG/ML10X1ML"="KETODOLAMP30MG/ML1ML10",
    "KETOMEDAMP30MG/ML10X1ML"="KETOMEDAMP30MG/ML1ML10",
    "KETRALAMP30MG/ML10X1ML"="KETRALAMP30MG/ML1ML10",
    "KORTEZORAMP30MG/ML10X1ML"="KORTEZORAMP30MG/ML1ML10",
    "LANTUSPENPFSOLOS100IU/ML5X3ML"="LANTUSPENPFSOLOSTAR100IU/ML3ML",
    "LANTUSPENPFSOLOSTAR100IU/ML3ML"="LANTUSPENPFSOLOSTAR100IU/ML3ML5",
    "LEVEMIRFLEXPEN100U/ML5X3ML"="LEVEMIRFLEXPEN100U/ML3ML5",
    "LOFENAXA.IM25MG/ML10X3ML"="LOFENAXA.IM25MG/ML3ML10",
    "MIXTARD30HMFLEXPEN100IU/ML5X3ML"="MIXTARD30HMFLEXPEN100IU/ML3ML5",
    "MNSAMP50MG/ML25X1ML"="MNSAMP50MG/ML1ML25",
    "MORPHINES.HOSPIAMP10MG/ML5X1ML"="MORPHINES.HOSPIAMP10MG/ML1ML5",
    "NALPHINEAMP10MG/ML10X1ML"="NALPHINEAMP10MG/ML1ML10",
    "NAPREXAMP300MG/2ML10X2ML"="NAPREXAMP300MG/2ML2ML10",
    "NEOXICAMTAB15MG30BLIS"="NEOXICAMTAB15MG30",
    "NEOXICAMTAB7.5MG30BLIS"="NEOXICAMTAB7.5MG30",
    "NOVOMIX30FLEXPENPEN100IU/ML5X3ML"="NOVOMIX30FLEXPENPEN100IU/ML3ML5",
    "NOVORAPIDFLEXPENPEN100IU/ML5X3ML"="NOVORAPIDFLEXPENPEN100IU/ML3ML5",
    "NUBAINAMP10MG100X1ML"="NUBAINAMP10MG1ML100",
    "NUBAINAMP10MG10X1ML"="NUBAINAMP10MG1ML10",
    "NUKAINEAMP10MG/ML100X1ML"="NUKAINEAMP10MG/ML1ML100",
    "OXYNORMAMP10MG/ML5X1ML"="OXYNORMAMP10MG/ML1ML5",
    "OXYNORMAMP10MG/ML5X2ML"="OXYNORMAMP10MG/ML2ML5",
    "PARASANAMP300MG/2ML10X2ML"="PARASANAMP300MG/2ML2ML10",
    "PENIMADOLAMP50MG/ML10X1ML"="PENIMADOLAMP50MG/ML1ML10",
    "PEPTRADAMP50MG/ML50X1ML"="PEPTRADAMP50MG/ML1ML50",
    "PLAZADOLA.IV50MG/ML10X2ML"="PLAZADOLA.IV50MG/ML2ML10",
    "PONSTANSUS50MG/5ML6X60ML"="PONSTANSUS50MG/5ML60ML6",
    "REMOPAINAMP30MG/ML5X1ML"="REMOPAINAMP30MG/ML1ML5",
    "RHEUFLAMAMP75MG3ML"="RHEUFLAMAMP75MG/3ML3ML1",
    "SCILINNCARTRIDGE100IU/ML5X3ML"="SCILINNCARTRIDGE100IU/ML3ML5",
    "SCILINRCARTRIDGE100IU/ML5X3ML"="SCILINRCARTRIDGE100IU/ML3ML5",
    "SCILINM30CARTRIDGE100IU/ML5X3ML"="SCILINM30CARTRIDGE100IU/ML3ML5",
    "SELECAP-200CAP200MG30"="SELECAPCAP200MG30",
    "SINOMOLA.IM300MG/2ML10X2ML"="SINOMOLA.IM300MG/2ML2ML10",
    "SKELANREFMTAB550MG100FOIL"="SKELANREFMTAB550MG100",
    "STREPSILSCHESTYLOZ15MG246"="STREPSILSCHESTYLOZ15MG24",
    "STREPSILSDRYLOZ5MG246"="STREPSILSDRYLOZ5MG24",
    "SYBRONAMP15MG/2ML10X2ML"="SYBRONAMP15MG/2ML2ML10",
    "TDLAMP50MG/ML10X2ML"="TDLAMP50MG/ML2ML10",
    "TOGESICAMP30MG/ML10X1ML"="TOGESICAMP30MG/ML1ML10",
    "TORADOLAMP30MG/ML5X1ML"="TORADOLAMP30MG/ML1ML5",
    "TRALAMP30MG/ML10X1ML"="TRALAMP30MG/ML1ML10",
    "TRAMADOLPWEALAMP100MG/2ML10X2ML"="TRAMADOLPWEALAMP100MG/2ML2ML10",
    "TRAMADOLPWEALAMP50MG/ML10X1ML"="TRAMADOLPWEALAMP50MG/ML1ML10",
    "TRAMALAMP100MG/2ML10X2ML"="TRAMALAMP100MG/2ML2ML10",
    "TRAMALAMP50MG/ML10X1ML"="TRAMALAMP50MG/ML1ML10",
    "VHERADOLAMP50MG/ML10X2ML"="VHERADOLAMP50MG/ML2ML10",
    "VICKSFORMU44PLUSSYR15MG/5ML12X60ML"="VICKSFORMU44PLUSSYR15MG/5ML120ML1",
    "VICTOZAPENPF6MG/ML2X3ML"="VICTOZAPENPF6MG/ML3ML2",
    "VIFENACA.IM25MG/ML10X3ML"="VIFENACA.IM25MG/ML3ML10",
    "VITRALAMP100MG/ML10X2ML"="VITRALAMP100MG/ML2ML10",
    "VITRALAMP50MG/ML10X1ML"="VITRALAMP50MG/ML1ML10",
    "VOLTARENA.IM75MG10X3ML"="VOLTARENA.IM75MG3ML10",
    "VORENAMP75MG10X3ML"="VORENAMP75MG3ML10",
    "ZETIFENSYR250MG60ML"="ZETIFENSYR250MG/5ML60ML1",
    "ZIROLACAMP30MG/ML10X1ML"="ZIROLACAMP30MG/ML1ML10",
    "ZOLIDTAB15MG14BLIS"="ZOLIDTAB15MG14",
    "ZOLIDTAB30MG14BLIS"="ZOLIDTAB30MG14"))

## Merge (left join) TC2 and Description_PFC
  TC2.merged <- merge(TC2, Description_PFC, "Product.Pack.Name_NOSPACE", all.x=TRUE)
  sum(is.na(TC2.merged$PFC))                    ##394 cases missing

## Resolve 394 missing cases
  
  ## Create variable Element that will be equal to "1" if the PFC is missing and will be equal to NA if false
  TC2.merged <- mutate(TC2.merged, Element = ifelse(is.na(TC2.merged$PFC), "1", ""))

  ## Paste Element variable and Product.Pack.Name_NOSPACE variable - Add character 1 to variable
  TC2.merged$Product.Pack.Name_NOSPACE <- paste(TC2.merged$Product.Pack.Name_NOSPACE, TC2.merged$Element, sep = "")

## Drop repetitive Variables in TC2.merged that are also in Description_PFC
  colnames(TC2.merged)
  TC2.merged$PFC <- NULL 
  TC2.merged$PFC.Product <- NULL 
  TC2.merged$PFC.Pack <- NULL 
  TC2.merged$PFC.Lab.Code <- NULL 
  TC2.merged$PFC.Lab.Desc<- NULL 
  TC2.merged$ATC <- NULL 
  TC2.merged$NFC <- NULL 
  TC2.merged$STUDYFLAG <- NULL 
  TC2.merged$DELFLAG <- NULL 
  TC2.merged$PFC.Product.Pack.Name <- NULL 
  TC2.merged$Element <- NULL 
  
##Merge TC2.M and Description_PFC as TC2.merged_v2
  TC2.merged_v2 <- merge(TC2.merged, Description_PFC, "Product.Pack.Name_NOSPACE", all.x=TRUE)
  sum(is.na(TC2.merged_v2$PFC))       ## 1 case still missing
  
## Drop repetitive Variables that are in TC2.merged_v2
  colnames(TC2.merged_v2)
  TC2.merged_v2$Product.Pack.Name_NOSPACE <- NULL
  TC2.merged_v2$Product <- NULL
  TC2.merged_v2$Product.Pack.Name <- NULL
  TC2.merged_v2$STUDYFLAG <- NULL 
  TC2.merged_v2$DELFLAG <- NULL
  TC2.merged_v2$PFC.Lab.Code <- NULL
 
## Reorder columns in preparation for analysis TC2.merged_v3 is just v2 with reordered columns
  refcols <- c("PFC",
               "PFC.Product",
               "PFC.Pack",
               "PFC.Product.Pack.Name", 
               "Pack.Molecule.String",
               "Drug.Therapeutic.Class", 
               "License.Type", 
               "Drug.Type", 
               "ATC", 
               "NFC", 
               "PFC.Lab.Desc")
  
  TC2.merged_v3 <- TC2.merged_v2[, c(refcols, setdiff(names(TC2.merged_v2), refcols))]

## Drop unnecessary files
  rm(TC2.merged, TC2, TC2.merged_v2, Description_PFC)
  
## Save in Dropbox/Edited as TC2.merged_v3.csv
  write.csv(TC2.merged_v3, "~/Dropbox/IMS data/Edited/TC2.merged_v3.csv")
  
## DONE
  ## Proceed to [4] Split

  